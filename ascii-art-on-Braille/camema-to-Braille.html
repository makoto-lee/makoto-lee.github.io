<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <title>Display Webcam Stream</title>

    <style>
        #container {
            margin: 0px auto;
            width: 480px;
            height: 360px;
            border: 3px #333 solid;
        }
    </style>
</head>

<body>
    <div style="text-align: center;">
        <div id="container">
        </div>
        <br>
        <pre><code id="output-text">demo</code></pre>
    </div>

    <!-- script for camera -->
    <script>
        const width = document.getElementById("container").offsetWidth;
        const height = document.getElementById("container").offsetHeight;

        const constraints = { //相機限制
            audio: false,
            video: {
                facingMode: "user"  //開前鏡頭
            }
        };

        const getFrameFromVideo = (video, canvas) => {
            const ctx = canvas.getContext("2d");
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.save();   //儲存狀態
            ctx.translate(video.width, 0);
            ctx.scale(-1, 1);
            ctx.drawImage(video, 0, 0, video.width, video.height);
            ctx.restore(); //到此才輸出，才不會還沒整體操作完就放出，會造成畫面快速抖動
            requestAnimationFrame(() => getFrameFromVideo(video, canvas));
        };

        const getCameraStream = video => { //要 camera 的權限
            navigator.mediaDevices
                .getUserMedia(constraints)
                .then(function success(stream) {
                    video.srcObject = stream;
                });
        };

        const createVideo = (id, width, height) => {
            const video = document.createElement("video");
            video.id = id;
            video.width = width;
            video.height = height;
            video.autoplay = true;
            video.controls = true;
            return video;
        };

        const createCanvas = (id, width, height) => {
            const canvas = document.createElement("canvas");
            canvas.id = id;
            canvas.width = width;
            canvas.height = height;
            return canvas;
        };


        const video = createVideo("vid", width, height);
        const canvas = createCanvas("canvas", width, height);
        const container = document.getElementById("container");
        getCameraStream(video);
        getFrameFromVideo(video, canvas);
        container.appendChild(canvas);
        console.log("init");

    </script>

    <!-- script for ascii art -->
    <script>
        function imageDataTo3DArray(pixels, width, height) {
            let rt = Array(height).fill().map(
                () => Array(width).fill().map(
                    () => new Uint8Array(4)));
            for (let i = 0; i < height; i++) {
                for (let j = 0; j < width; j++) {
                    const index = 4 * (i * width + j);
                    rt[i][j][0] = pixels[index];
                    rt[i][j][1] = pixels[index + 1];
                    rt[i][j][2] = pixels[index + 2];
                    rt[i][j][3] = pixels[index + 3];
                }
            }
            return rt;
        }

        function toGrayScale2DArray(img_data, width, height) {
            let rt = Array(height).fill().map(
                () => new Uint8Array(width).fill());
            for (let i = 0; i < height; i++) {
                for (let j = 0; j < width; j++) {
                    rt[i][j] = img_data[i][j][0] * 0.299 + img_data[i][j][1] * 0.587 + img_data[i][j][2] * 0.114;
                }
            }
            return rt;
        }
        // 1 4 2 5 3 6 7 8
        function genUnicodeTable(start, length) {
            return String.fromCharCode(
                ...Array(length).fill().map((_, i) => start + i)
            );
        }

        function filter2D(arr, x, y, len_x, len_y) {
            let tmp = 0;
            for (let i = 0; i < len_x; i++) {
                for (let j = 0; j < len_y; j++) {
                    tmp += arr[x + i][y + j];
                }
            }
            return tmp / (len_x * len_y);
        }

        function extract2DArray(arr, x, y, len_x, len_y) {
            let rt = Array(len_x).fill().map(
                () => new Uint8Array(len_y).fill());
            for (let i = 0; i < len_x; i++) {
                for (let j = 0; j < len_y; j++) {
                    rt[i][j] = arr[x + i][y + j];
                }
            }
            return rt;
        }

        const Braille_dots_val = [1, 4, 16, 2, 8, 32, 64, 128];

        function getBrailleChar(block, height, width) {
            let dots = new Uint8Array(8);
            let edge_len = width / 2;
            for (let i = 0; i < 4; i++) {
                for (let j = 0; j < 2; j++) {
                    dots[i * 2 + j] = filter2D(block, i * edge_len, j * edge_len, edge_len, edge_len);
                }
            }
            for (let i = 0; i < 8; i++) {
                if (reverse) {
                    if (dots[i] <= black_white_bound)
                        dots[i] = 0;
                    else
                        dots[i] = 1;
                }
                else {
                    if (dots[i] <= black_white_bound)
                        dots[i] = 1;
                    else
                        dots[i] = 0;
                }
            }
            let fff = true;

            let idx_diff = 0;
            for (let i = 0; i < 8; i++) {
                if (dots[i]) {
                    idx_diff += Braille_dots_val[i];
                }
            }
            if (idx_diff != 0)
                return String.fromCharCode(0x2800 + idx_diff);
            return String.fromCharCode(0x2801);
        }

        function getBrailleString(img, height, width, dpi) {

            let rt = String("");
            let block_height = dpi * 4;
            let block_width = dpi * 2;

            for (let i = 0; i < height / block_height - 1; i++) {
                for (let j = 0; j < width / block_width - 1; j++) {
                    let block = extract2DArray(img, i * block_height, j * block_width, block_height, block_width);
                    rt += getBrailleChar(block, block_height, block_width);
                }
                rt += '\n';
            }
            return rt;
        }
    </script>

    <!-- scripts for executing & loop -->
    <script>
        const ctx = canvas.getContext("2d");
        const output_textarea = document.getElementById('output-text');
        const DPIMAX = 99;
        const DPIMIN = 1;
        var black_white_bound = 125;
        var dpi = 2;
        var reverse = true;

        function execute() {
            let pixels = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
            const img_buf = imageDataTo3DArray(pixels, canvas.width, canvas.height);
            const img_buf_gray = toGrayScale2DArray(img_buf, canvas.width, canvas.height);

            output_textarea.textContent = getBrailleString(img_buf_gray, canvas.height, canvas.width, dpi);
        }

        // keep run it
        setInterval(execute, 50);

    </script>
</body>

</html>